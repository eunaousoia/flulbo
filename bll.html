<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Football</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 100%);
            font-family: Arial, sans-serif;
        }

        canvas {
            display: block;
            background: #2d5016;
            margin: 20px auto;
            border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="info">
        <div>Controles:</div>
        <div>E - Agarrar pelota</div>
        <div>Click/X - Lanzar pelota</div>
        <div>WASD / Flechas - Mover</div>
        <div id="playerId"></div>
    </div>
    <div id="score">
        <div>游댯 Azul: <span id="blueScore">0</span></div>
        <div>游댮 Rojo: <span id="redScore">0</span></div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCw0v9mVUpOO8HYYfHLhyzkgIMfoBljJcQ",
            authDomain: "fortnite-8012b.firebaseapp.com",
            databaseURL: "https://fortnite-8012b-default-rtdb.firebaseio.com",
            projectId: "fortnite-8012b",
            storageBucket: "fortnite-8012b.firebasestorage.app",
            messagingSenderId: "862924450554",
            appId: "1:862924450554:web:b01ab7f85afa7965c2f743",
            measurementId: "G-8Q997GYMM2"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('playerId').textContent = 'ID: ' + playerId.substr(7);

        const PLAYER_RADIUS = 20;
        const BALL_RADIUS = 12;
        const PLAYER_SPEED = 5;
        const BALL_THROW_SPEED = 15;
        const GOAL_WIDTH = 150;

        let myPlayer = {
            x: Math.random() * (canvas.width - 100) + 50,
            y: Math.random() * (canvas.height - 100) + 50,
            color: Math.random() > 0.5 ? '#0066ff' : '#ff0000',
            hasBall: false
        };

        let players = {};
        let ball = { x: canvas.width / 2, y: canvas.height / 2, vx: 0, vy: 0, owner: null };
        let score = { blue: 0, red: 0 };
        let keys = {};

        // Escuchar jugadores
        const playersRef = ref(database, 'players');
        onValue(playersRef, (snapshot) => {
            players = snapshot.val() || {};
        });

        // Escuchar pelota
        const ballRef = ref(database, 'ball');
        onValue(ballRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Solo NO actualizar si YO soy el due침o
                if (data.owner !== playerId) {
                    ball = data;
                }
            }
        });

        // Escuchar puntuaci칩n
        const scoreRef = ref(database, 'score');
        onValue(scoreRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                score = data;
                document.getElementById('blueScore').textContent = score.blue;
                document.getElementById('redScore').textContent = score.red;
            }
        });

        // Actualizar mi jugador en Firebase
        function updateMyPlayer() {
            set(ref(database, 'players/' + playerId), myPlayer);
        }

        // Actualizar pelota
        function updateBall() {
            set(ref(database, 'ball'), ball);
        }

        // Controles
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;

            if (e.key.toLowerCase() === 'e') {
                grabBall();
            }

            if (e.key.toLowerCase() === 'x') {
                throwBall();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        canvas.addEventListener('click', () => {
            throwBall();
        });

        function grabBall() {
            if (ball.owner) return;

            const dist = Math.hypot(myPlayer.x - ball.x, myPlayer.y - ball.y);
            if (dist < PLAYER_RADIUS + BALL_RADIUS + 20) {
                ball.owner = playerId;
                ball.vx = 0;
                ball.vy = 0;
                myPlayer.hasBall = true;
                updateBall();
                updateMyPlayer();
            }
        }

        function throwBall() {
            if (ball.owner !== playerId) return;

            // Lanzar hacia la porter칤a contraria
            const targetX = myPlayer.color === '#0066ff' ? canvas.width : 0;
            const targetY = canvas.height / 2;

            const dx = targetX - myPlayer.x;
            const dy = targetY - myPlayer.y;
            const dist = Math.hypot(dx, dy);

            ball.vx = (dx / dist) * BALL_THROW_SPEED;
            ball.vy = (dy / dist) * BALL_THROW_SPEED;
            ball.owner = null;
            myPlayer.hasBall = false;

            updateBall();
            updateMyPlayer();
        }

        function updatePlayerPosition() {
            let moved = false;

            if ((keys['w'] || keys['arrowup']) && myPlayer.y > PLAYER_RADIUS) {
                myPlayer.y -= PLAYER_SPEED;
                moved = true;
            }
            if ((keys['s'] || keys['arrowdown']) && myPlayer.y < canvas.height - PLAYER_RADIUS) {
                myPlayer.y += PLAYER_SPEED;
                moved = true;
            }
            if ((keys['a'] || keys['arrowleft']) && myPlayer.x > PLAYER_RADIUS) {
                myPlayer.x -= PLAYER_SPEED;
                moved = true;
            }
            if ((keys['d'] || keys['arrowright']) && myPlayer.x < canvas.width - PLAYER_RADIUS) {
                myPlayer.x += PLAYER_SPEED;
                moved = true;
            }

            return moved;
        }

        function updateBallPhysics() {
            if (ball.owner === playerId) {
                ball.x = myPlayer.x;
                ball.y = myPlayer.y;
                return true;
            }

            if (ball.owner) return false;

            ball.x += ball.vx;
            ball.y += ball.vy;

            // Fricci칩n
            ball.vx *= 0.98;
            ball.vy *= 0.98;

            if (Math.abs(ball.vx) < 0.1) ball.vx = 0;
            if (Math.abs(ball.vy) < 0.1) ball.vy = 0;

            // Rebote en paredes verticales (solo si no es gol)
            if (ball.y - BALL_RADIUS < 0 || ball.y + BALL_RADIUS > canvas.height) {
                ball.vy *= -0.8;
                ball.y = Math.max(BALL_RADIUS, Math.min(canvas.height - BALL_RADIUS, ball.y));
            }

            // Rebote en paredes horizontales (solo fuera del 치rea de gol)
            const goalTop = (canvas.height - GOAL_WIDTH) / 2;
            const goalBottom = (canvas.height + GOAL_WIDTH) / 2;

            if (ball.x - BALL_RADIUS < 0) {
                if (ball.y < goalTop || ball.y > goalBottom) {
                    ball.vx *= -0.8;
                    ball.x = BALL_RADIUS;
                } else {
                    // GOL para rojo
                    score.red++;
                    resetBall();
                    set(ref(database, 'score'), score);
                    return true;
                }
            }

            if (ball.x + BALL_RADIUS > canvas.width) {
                if (ball.y < goalTop || ball.y > goalBottom) {
                    ball.vx *= -0.8;
                    ball.x = canvas.width - BALL_RADIUS;
                } else {
                    // GOL para azul
                    score.blue++;
                    resetBall();
                    set(ref(database, 'score'), score);
                    return true;
                }
            }

            return true;
        }

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.vx = 0;
            ball.vy = 0;
            ball.owner = null;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Campo
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // L칤neas del campo
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;

            // L칤nea central
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();

            // C칤rculo central
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 60, 0, Math.PI * 2);
            ctx.stroke();

            // Porter칤as
            const goalTop = (canvas.height - GOAL_WIDTH) / 2;
            const goalBottom = (canvas.height + GOAL_WIDTH) / 2;

            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, goalTop, 10, GOAL_WIDTH);

            ctx.fillStyle = '#0066ff';
            ctx.fillRect(canvas.width - 10, goalTop, 10, GOAL_WIDTH);

            // Dibujar jugadores
            Object.entries(players).forEach(([id, player]) => {
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, PLAYER_RADIUS, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                if (player.hasBall) {
                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, PLAYER_RADIUS + 5, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });

            // Dibujar pelota
            // Buscar al jugador que tiene la pelota (igual que el efecto amarillo)
            let ballX = ball.x;
            let ballY = ball.y;

            // Buscar en todos los jugadores qui칠n tiene hasBall = true
            Object.entries(players).forEach(([id, player]) => {
                if (player.hasBall) {
                    ballX = player.x;
                    ballY = player.y;
                }
            });

            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(ballX, ballY, BALL_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Game loop a 60 FPS
        let lastUpdate = Date.now();
        setInterval(() => {
            const moved = updatePlayerPosition();
            const ballUpdated = updateBallPhysics();

            if (moved) {
                updateMyPlayer();
            }

            // Actualizar pelota si no tiene due침o O si yo soy el due침o
            if (ballUpdated && (ball.owner === playerId || !ball.owner)) {
                updateBall();
            }

            draw();
        }, 1000 / 60);

        // Limpiar jugador al salir
        window.addEventListener('beforeunload', () => {
            remove(ref(database, 'players/' + playerId));
        });

        // Inicializar
        updateMyPlayer();
        if (!ball.x) {
            updateBall();
        }
        if (!score.blue) {
            set(ref(database, 'score'), score);
        }
    </script>
</body>

</html>